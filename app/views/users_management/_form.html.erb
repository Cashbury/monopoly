<% content_for (:head) do %> 
  <%= stylesheet_link_tag "users_management" %>
  <%= javascript_include_tag 'users_management_scripts', 'bday-picker.min'%>
  <%= javascript_tag do %>
    var total_legals = <%= @total %>;
    var legal_index = <%= @legal_ids.empty? ? 0 : @legal_ids.length %>;
  <% end -%>
<% end %>


<%= form_for @user, url: @user.new_record? ? :users_management_index : :users_management, html: { class: "mono-form", multipart: true } do |f| %>
  <% if @user.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@user.errors.count, "error") %> prohibited this user from being saved:</h2>
      <ul>
        <% @user.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
  <fieldset >
    <legend>User Information</legend>
    <p>
      <%= f.label :roles, "Select User Roles" %><br />
      <%= hidden_field_tag "user[role_ids][]", nil %>
      <% Role.all.each do |role| %>
        <%= check_box_tag(
                          "user[role_ids][]",
                          role.id,
                          @user.role_ids.include?(role.id), {id: dom_id(role), class: "role_box" }) %>
        <%= label_tag dom_id(role), "#{role.displayed_role}"%><br />
      <% end %>
    </p>
    <% if @show_biz_and_place %>
      <p class="brands_list">
    <% else %>
      <p class="brands_list" style="display:none">
    <% end %>
        <%= label_tag "Brand" %>
        <%= select_tag :brand_id , "<option value=''>Select brand...</option>".html_safe + options_from_collection_for_select(@brands, "id", "name", params[:brand_id] || @brand.try(:id))%>
      </p>
    <% if @show_biz_and_place %>
      <p class="businesses_list">
    <% else %>
      <p class="businesses_list" style="display:none">
    <% end %>
        <%= label_tag "Business" %>
        <%= f.select :business_id , "<option value=''>Select business...</option>".html_safe + options_from_collection_for_select(@businesses, "id", "name", (params[:user].present? and params[:user][:business_id]) || @business.try(:id) )%>
      </p>
    <% if @show_biz_and_place %>
      <p class="places_list">
    <% else %>
      <p class="places_list" style="display:none">
    <% end %>
        <%= label_tag "Place" %>
        <%= f.select :place_id , "<option value=''>Select place...</option>".html_safe +  options_from_collection_for_select(@places, "id", "name", (params[:user].present? and params[:user][:place_id]) || @place.try(:id)) %>
      </p>
    <p>
      <%= f.label :first_name %>
      <%= f.text_field :first_name , class: "title" %>
    </p>
    <p>
      <%= f.label :last_name %>
      <%= f.text_field :last_name , class: "title" %>
    </p>
    <p>
      <%= f.label :dob, "Date of birth" %><br/>
      <%= f.date_select :dob, prompt: true , start_year: Date.today.year, end_year: (Date.today.year - 100) %>
    </p>

    <p>
      <%= f.label :home_town %>
      <%= f.collection_select :home_town,  Country.all , :id, :name, include_blank: "Select Country" %>
    </p>
    <p>
      <%= f.label :note %>
      <%= f.text_area :note %>
    </p>
    <p>
      <%= f.label :telephone_number %><br/>
      <span class="code"><%= @user.country.try(:phone_country_code) %></span> 
      <%= f.text_field :telephone_number , class: "title", value: @user.phone_without_code , style: "width: 263px;" %>      
    </p>
    <div class="legal_type_class">
      <%= label_tag "Legal IDs" %>
        <% if params[:user].present? and params[:user][:legal_ids_arr].present? and params[:user][:legal_ids_arr].any? %>
          <% params[:user][:legal_ids_arr].each_with_index do |legal_id,index| %>
            <div class="legals_div">
              <%= select_tag "user[legal_types][]" , "<option value=''>...Select Legal Type...</option>".html_safe +  options_from_collection_for_select(LegalType.all, "id", "displayed_type",params[:user][:legal_types][index]), { id: "legal_types_#{index}"} %><%= text_field_tag "user[legal_ids_arr][]",legal_id, { class: "title", id: "legal_ids_#{index}" }%>
              <%if index == 0 %>
              <a href="javascript:void(0)" class="add_link"><img style="margin-top:3px" src="/images/add.png"/> </a>
              <% else %>
              <a href="javascript:void(0)" class="remove_link"><img style="margin-top:3px" src="/images/remove.png"/> </a>
              <% end %>
            </div>
          <% end %>
        <% elsif @legal_ids.empty? %>
          <div class="legals_div">
            <%= select_tag "user[legal_types][]" , "<option value=''>...Select Legal Type...</option>".html_safe +  options_from_collection_for_select(LegalType.all, "id", "displayed_type"), { id: "legal_types_0"}%><%= text_field_tag "user[legal_ids_arr][]","", { class: "title", id: "legal_ids_0" }%>
            <a href="javascript:void(0)" class="add_link"><img style="margin-top:3px" src="/images/add.png"/> </a>
          </div>
        <% else %>
          <% @legal_ids.each_with_index do |legal_id,index| %>
            <div class="legals_div">
              <%= select_tag "user[legal_types][]" , "<option value=''>...Select Legal Type...</option>".html_safe +  options_from_collection_for_select(LegalType.all, "id", "displayed_type",legal_id.legal_type.id), {:id=>"legal_types_#{index}"}%><%= text_field_tag "user[legal_ids_arr][]",legal_id.id_number, { class: "title", id: "legal_ids_#{index}" }%>
              <%if index == 0 %>
              <a href="javascript:void(0)" class="add_link"><img style="margin-top:3px" src="/images/add.png"/> </a>
              <% else %>
              <a href="javascript:void(0)" class="remove_link"><img style="margin-top:3px" src="/images/remove.png"/> </a>
              <% end %>
            </div>
          <% end %>
      <% end %>            
    </div>

    <% if f.object.new_record? %>
        <%= f.label :user_image, "Upload Image" %>
        <%= f.fields_for :user_image do |builder| %>
          <%= builder.file_field :photo %>          
        <% end -%>
        <small>Maximum size of 3MB, Supported images JPG, GIF, PNG, JPEG, BMP</small>
    <% end -%>
  </fieldset>

  <fieldset>
      <legend>User Account</legend>
      <p>
        <%= f.label :username %><br/>
        <%= f.text_field :username , class: "title U_username" %>
        <img src="/images/loading.gif" width="16" height="16" alt="Loading" style="display:none;" />
        <span class="form-note note-error L-error" <%= 'style="display:none;"' unless @user.errors[:username].any? %>>
          <%= @user.errors[:username].first %>
        </span>
        <span class="form-note note-success L-success" style="display:none;"></span>
      </p>
      <p>
        <%= f.label :email %>
        <%= f.text_field :email , class: "title U_email" %></br>
        <img src="/images/loading.gif" width="16" height="16" alt="Loading" style="display:none;" />
        <span class="form-note note-error L-error" <%= 'style="display:none;"' unless @user.errors[:username].any? %>>
          <%= @user.errors[:email].first %>
        </span>
        <span class="form-note note-success L-success" style="display:none;"></span>
      </p>
      <p>
          <%= f.label :active, class: "custom_checkbox_label" %>
          <%= f.check_box :active, default: true, class:  "custom_checkbox" %>
      </p>
    </fieldset>

  <div class="tabs">
    <ul>
      <li><a href="#mailing" data-c="Mailing">Mailing Address</a></li>
      <li><a href="#billing" data-c="Billing">Billing Address</a></li>
    </ul>
    <div id="mailing">
      <fieldset style="border:none">
        <%= f.fields_for :mailing_address, @user.try(:mailing_address) do |mailing_address_form| %>
          <p>
            <%= mailing_address_form.label :city %>
            <%= mailing_address_form.select :city_id, "<option value=''>..Select City..</option>".html_safe + options_from_collection_for_select(City.all, :id, :name, mailing_address_form.object.try(:city_id))%>
          </p>
          <p>
            <%= mailing_address_form.label :street_address %>
            <%= mailing_address_form.text_field :street_address, :class=>"title" %>
          </p>
          <p>
            <%= mailing_address_form.label :zipcode %>
            <%= mailing_address_form.text_field :zipcode, :class=>"title" %>
          </p>
        <% end %>
      </fieldset>
    </div>
    <div id="billing">
      <fieldset style="border:none">
        <%= f.fields_for :billing_address, @user.try(:billing_address) do |billing_address_form| %>
          <p>
            <%= billing_address_form.label :city %>
            <%= billing_address_form.select :city_id, "<option value=''>..Select City..</option>".html_safe + options_from_collection_for_select(City.all, :id, :name,billing_address_form.object.try(:city_id))%>
          </p>
          <p>
            <%= billing_address_form.label :street_address %>
            <%= billing_address_form.text_field :street_address, :class=>"title" %>
          </p>
          <p>
            <%= billing_address_form.label :zipcode %>
            <%= billing_address_form.text_field :zipcode, :class=>"title" %>
          </p>
        <%end%>
      </fieldset>
    </div>
  </div>

  <%= toggle_fb_link(@user) %>

  <div class="actions">
    <%= f.submit @user.new_record? ? "Add" : "Update", class: "submit_btn #{@user.new_record? ? '' : 'update_btn' }" %>
  </div>
<% end %>